# GitHub Contribution Gravity Lens

## ルール
1. @claude/log/fix2_log.md に作業ログを残す
2. 実装はアーキテクチャ分割する

## Top X% Based Animation – Revision Specification

---

## 1. 改修目的

従来の「最大コミット日を中心とする単一点重力モデル」では、
以下の問題が発生していた：

* 多くのユーザーで似たようなアニメーションになる
* 昨日多くコミットしても視覚変化が小さい場合がある
* 分布の個性が表現できない

本改修では、**上位X%の日を採用する分布ベースモデル**へ変更し、
ユーザーごとの活動特性が視覚に反映される設計とする。

---

## 2. 基本方針

* 単一最大値依存を廃止
* 上位X%の日を「異常点」として扱う
* 局所的な空間変化を発生させる
* 静かで上品な異常感を維持する

推奨値：

```
X = 10%
```

---

## 3. 上位X%検出仕様

### 3.1 閾値計算

```
threshold = percentile(allCounts, 100 - X)
```

### 3.2 異常点定義

```
anomaly = count >= threshold
```

### 3.3 外れ値対策

```
maxCount = percentile95(allCounts)
normalized = min(count, maxCount) / maxCount
```

---

## 4. レイヤー構造設計

### 4.1 レイヤーA：通常空間

* 標準ヒートマップ表示
* 歪曲なし
* 静的

### 4.2 レイヤーB：異常空間（上位X%のみ）

* 局所歪曲
* 微弱発光
* 色相変化

異常点は別物理層として扱う。

---

## 5. 局所レンズ設計

### 5.1 変形対象

異常点セルおよびその周囲半径R以内のセル

```
R = 40px
```

### 5.2 局所歪曲式

```
dx = x - ax
dy = y - ay
r2 = dx*dx + dy*dy + epsilon
factor = clamp(k * mass / r2, 0, MAX_WARP)

x' = x + dx * factor
y' = y + dy * factor
```

複数異常点が存在する場合：

```
x' = x + Σ(dx_i * factor_i)
y' = y + Σ(dy_i * factor_i)
```

---

## 6. アニメーション設計

### 全体ループ：4秒

#### Phase 1（0–1秒）

静止状態

#### Phase 2（1–1.3秒）

異常点のみ明度をわずかに上昇

#### Phase 3（1.3–2.5秒）

局所レンズ発生

#### Phase 4（2.5–3.2秒）

レンズ干渉（複数存在時）

#### Phase 5（3.2–4秒）

自然復元

イージング：

```
cubic-bezier(0.4, 0.0, 0.2, 1)
```

---

## 7. ビジュアル設計

### 7.1 通常カラーパレット

```
Base:   #13202b
Level1: #1f3b4d
Level2: #255d73
Level3: #2e86a7
Level4: #66c2ff
```

### 7.2 異常点カラー

```
Accent: #3ddcff
Highlight: #5ee6ff
```

* opacity 0.15以下
* グローは極小

---

## 8. 微細立体演出

* 異常点セルのみZ方向に+1px
* 影は使用しない
* シャープネスをわずかに上げる

目的：視覚的優位性の付与

---

## 9. レイアウト仕様

* セルサイズ: 11px
* ギャップ: 4px
* 角丸: 2px

---

## 10. 禁止事項

* 全体歪曲
* 強い発光
* 派手な色変化
* パーティクル

---

## 11. 成功基準

* 上位X%の分布が明確に視覚化される
* ユーザーごとにアニメーション構造が異なる
* 静止状態でも美しい
* READMEで違和感を生むが騒がしくない

---

## 12. 非機能要件

* GIF 2MB以下
* SVG互換
* 高解像度対応
* GitHub背景とのコントラスト確保

---

## 13. ライセンス

MIT
